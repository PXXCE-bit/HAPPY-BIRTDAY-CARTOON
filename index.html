<!doctype html>
<html lang="th">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>üéÑ ‡∏†‡∏≤‡∏£‡∏Å‡∏¥‡∏à‡∏ß‡∏±‡∏ô‡πÄ‡∏Å‡∏¥‡∏î</title>

<style>
:root{
--bg:#070a18;
--fg:#eaf2ff;
--muted:#a9b7df;
--accent:#66ffcc;
--danger:#ff6b6b;
--card: rgba(10,16,40,.62);
--border: rgba(255,255,255,.12);
--gold: #ffd966;
}
*{ box-sizing:border-box; }

body{
margin:0;
min-height:100vh;
font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", monospace;
background: radial-gradient(1100px 520px at 50% 15%, #1b2a66, var(--bg));
color:var(--fg);
overflow-y:auto;
overflow-x:hidden;
-webkit-overflow-scrolling:touch;
}

canvas{ position:fixed; inset:0; pointer-events:none; }
#snow{ z-index:0; }
#confetti{ z-index:1; }
#fire{ z-index:1; }

.lights{
position:fixed;
left:0; right:0; top:0;
height:44px;
pointer-events:none;
z-index:2;
display:flex;
gap:10px;
padding:10px 12px;
opacity:.95;
}
.lights i{
width:10px; height:18px;
border-radius:999px;
background:rgba(255,255,255,.6);
box-shadow:0 0 14px rgba(255,255,255,.35);
animation:twinkle 1.2s infinite ease-in-out;
}
.lights i:nth-child(3n){ animation-delay:.2s; }
.lights i:nth-child(4n){ animation-delay:.4s; }
.lights i:nth-child(5n){ animation-delay:.6s; }
@keyframes twinkle{
0%,100%{ opacity:.35; transform:translateY(0); filter:saturate(1); }
50%{ opacity:1; transform:translateY(1px); filter:saturate(1.8); }
}

.wrap{
position:relative;
z-index:3;
width:min(980px,94vw);
margin:70px auto 24px;
padding:14px;
display:grid;
gap:12px;
grid-template-columns: 1.1fr .9fr;
}
@media(max-width:980px){
.wrap{ grid-template-columns:1fr; margin-top:62px; }
}

.card{
background:var(--card);
border:1px solid var(--border);
border-radius:18px;
box-shadow:0 22px 70px rgba(0,0,0,.5);
backdrop-filter: blur(10px);
padding:18px;
}

h1{ margin:0 0 6px 0; font-size:20px; }
.sub{ margin:0 0 12px 0; color:var(--muted); font-size:13px; }
.row{ display:flex; gap:10px; align-items:center; flex-wrap:wrap; }
.panel{
border:1px solid rgba(255,255,255,.12);
border-radius:16px;
padding:14px;
background:rgba(0,0,0,.20);
}
.big{ font-size:26px; line-height:1.2; margin:0; }
.prompt{ color:var(--accent); }
.err{ min-height:18px; color:var(--danger); font-size:13px; margin-top:8px; }

input, button{
border-radius:12px;
border:1px solid rgba(255,255,255,.15);
background:rgba(0,0,0,.22);
color:var(--fg);
padding:12px 12px;
outline:none;
font:inherit;
}
input{ flex:1; min-width:220px; }
button{
cursor:pointer;
background: linear-gradient(135deg, rgba(102,255,204,.22), rgba(134,168,255,.16));
user-select:none;
-webkit-user-select:none;
-webkit-touch-callout:none;
}
button:hover{ transform: translateY(-1px); }
button:disabled{ opacity:.55; cursor:not-allowed; transform:none; }

.bar{
width:100%;
height:10px;
border-radius:999px;
background:rgba(255,255,255,.10);
overflow:hidden;
border:1px solid rgba(255,255,255,.12);
}
.fill{
height:100%;
width:0%;
background:linear-gradient(90deg, rgba(102,255,204,.9), rgba(134,168,255,.9));
}

.gallery{ display:grid; gap:10px; }
.photo{
width:100%;
aspect-ratio:16/10;
border-radius:14px;
border:1px solid rgba(255,255,255,.12);
background:rgba(0,0,0,.22);
overflow:hidden;
display:flex;
align-items:center;
justify-content:center;
position:relative;
}
.photo img{ width:100%; height:100%; object-fit:cover; display:block; }
.cap{
position:absolute;
left:10px;
bottom:10px;
padding:6px 10px;
border-radius:999px;
background:rgba(0,0,0,.42);
border:1px solid rgba(255,255,255,.14);
font-size:12px;
backdrop-filter: blur(6px);
}

.hidden{ display:none !important; }

.letter{
white-space:pre-wrap;
line-height:1.85;
font-size:14px;
}
.cursor{
display:inline-block;
width:8px;
margin-left:2px;
opacity:.9;
animation: blink .9s steps(2,start) infinite;
}
@keyframes blink{ 50%{ opacity:0; } }

.toast{
position:fixed;
left:50%;
top:52px;
transform:translateX(-50%);
padding:10px 12px;
border-radius:12px;
background:rgba(0,0,0,.55);
border:1px solid rgba(255,255,255,.14);
color:var(--fg);
font-size:13px;
opacity:0;
pointer-events:none;
transition: opacity .25s ease, transform .25s ease;
z-index:5;
text-align:center;
max-width:min(92vw,520px);
}
.toast.show{
opacity:1;
transform:translateX(-50%) translateY(4px);
}

/* ===== Intro envelope ===== */
.envelope{
width: min(520px, 92vw);
margin: 0 auto;
border-radius: 18px;
background: rgba(255,255,255,.06);
border: 1px solid rgba(255,255,255,.14);
padding: 16px;
position: relative;
overflow: hidden;
}
.env-top{
height: 120px;
border-radius: 14px;
background:
linear-gradient(135deg, rgba(255,255,255,.10), rgba(0,0,0,.10));
border:1px solid rgba(255,255,255,.10);
position:relative;
}
.env-top:before{
content:"";
position:absolute;
inset:-24px -24px auto -24px;
height: 140px;
background: linear-gradient(180deg, rgba(255,255,255,.20), transparent);
transform: skewY(-8deg);
opacity:.25;
}
.env-mid{
margin-top: 12px;
padding: 14px;
border-radius: 14px;
background: rgba(0,0,0,.22);
border:1px solid rgba(255,255,255,.12);
text-align:center;
}

.fingerWrap{
display:flex;
justify-content:center;
margin-top:12px;
}
.finger{
width:110px;
height:110px;
border-radius:999px;
border:1px solid rgba(255,255,255,.16);
background: radial-gradient(circle at 30% 30%, rgba(255,255,255,.14), rgba(0,0,0,.20));
box-shadow: 0 18px 50px rgba(0,0,0,.35);
display:flex;
align-items:center;
justify-content:center;
position:relative;
touch-action:none;
}
.finger svg{
width:64px; height:64px;
opacity:.92;
filter: drop-shadow(0 8px 18px rgba(0,0,0,.35));
}
.ring{
position:absolute;
inset:8px;
border-radius:999px;
border:2px solid rgba(255,255,255,.10);
}
.ring::after{
content:"";
position:absolute;
inset:-2px;
border-radius:999px;
border:2px solid rgba(102,255,204,.85);
clip-path: polygon(50% 50%, 50% 0, 50% 0, 50% 50%);
opacity:0;
}
.finger.holding .ring::after{
opacity:1;
animation: none;
}
.holdText{
margin-top:10px;
color:var(--muted);
font-size:13px;
}

/* ===== Timing game ===== */
.timingBox{
border-radius:14px;
border:1px solid rgba(255,255,255,.12);
background: rgba(0,0,0,.22);
padding:14px;
}
.timingTrack{
position:relative;
height: 16px;
border-radius:999px;
background: rgba(255,255,255,.10);
border:1px solid rgba(255,255,255,.12);
overflow:hidden;
}
.timingZone{
position:absolute;
top:0; bottom:0;
left: 42%;
width: 16%;
background: linear-gradient(90deg, rgba(255,217,102,.35), rgba(255,217,102,.65));
border-left: 1px solid rgba(255,255,255,.18);
border-right: 1px solid rgba(255,255,255,.18);
}
.timingPointer{
position:absolute;
top:-10px;
width: 10px;
height: 36px;
border-radius: 8px;
background: rgba(102,255,204,.95);
box-shadow: 0 12px 25px rgba(102,255,204,.18);
left:0%;
transform: translateX(-50%);
}
.badge{
display:inline-flex;
align-items:center;
gap:8px;
padding:8px 10px;
border-radius:999px;
border:1px solid rgba(255,255,255,.12);
background: rgba(0,0,0,.22);
color:var(--muted);
font-size:12px;
}

/* ===== Maze canvas ===== */
.mazeWrap{
display:grid;
gap:12px;
}
#maze{
width:100%;
height:auto;
border-radius:14px;
border:1px solid rgba(255,255,255,.12);
background: rgba(0,0,0,.18);
touch-action:none;
}
.mazeHint{
color:var(--muted);
font-size:13px;
}
</style>
</head>

<body>
<canvas id="snow"></canvas>
<canvas id="confetti"></canvas>
<canvas id="fire"></canvas>
<div class="lights" id="lights" aria-hidden="true"></div>
<div class="toast" id="toast"></div>

<div class="wrap">
<!-- LEFT -->
<div class="card">
<h1>üéÑ ‡∏†‡∏≤‡∏£‡∏Å‡∏¥‡∏à‡∏ß‡∏±‡∏ô‡πÄ‡∏Å‡∏¥‡∏î (PEACE ‚Üí Cartoon)</h1>
<p class="sub">‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏à‡∏≤‡∏Å‡∏Å‡∏≤‡∏£ ‚Äú‡∏™‡πÅ‡∏Å‡∏ô‡∏•‡∏≤‡∏¢‡∏ô‡∏¥‡πâ‡∏ß‡∏°‡∏∑‡∏≠‚Äù ‚Üí ‡πÄ‡∏•‡πà‡∏ô 2 ‡πÄ‡∏Å‡∏° ‚Üí ‡πÅ‡∏•‡πâ‡∏ß‡∏Ñ‡πà‡∏≠‡∏¢‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏†‡∏≤‡∏£‡∏Å‡∏¥‡∏à‡∏´‡∏•‡∏±‡∏Å</p>

<!-- Progress -->
<div class="panel">
<div class="row" style="justify-content:space-between;">
<div class="sub">‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞</div>
<div class="sub">‡∏Ç‡∏±‡πâ‡∏ô‡∏ï‡∏≠‡∏ô <span id="stepLabel">0</span>/9</div>
</div>
<div class="bar" style="margin-top:8px"><div class="fill" id="fill"></div></div>
</div>

<!-- INTRO: Envelope + fingerprint hold -->
<div class="panel" id="introPanel" style="margin-top:12px">
<p class="big">‚úâÔ∏è ‡∏à‡∏î‡∏´‡∏°‡∏≤‡∏¢‡∏•‡∏±‡∏ö</p>
<p class="sub">‡∏™‡πÅ‡∏Å‡∏ô‡∏•‡∏≤‡∏¢‡∏ô‡∏¥‡πâ‡∏ß‡∏°‡∏∑‡∏≠‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏õ‡∏•‡∏î‡∏•‡πá‡∏≠‡∏Å</p>

<div class="envelope">
<div class="env-top"></div>
<div class="env-mid">
<div class="sub" style="margin:0">
‡πÇ‡∏õ‡∏£‡∏î‡∏™‡πÅ‡∏Å‡∏ô‡∏•‡∏≤‡∏¢‡∏ô‡∏¥‡πâ‡∏ß‡∏°‡∏∑‡∏≠
</div>

<div class="fingerWrap">
<div class="finger" id="finger">
<div class="ring"></div>
<!-- fingerprint icon -->
<svg viewBox="0 0 24 24" fill="none" aria-hidden="true">
<path d="M12 3c-4 0-7 3-7 7v3c0 3.314 2.686 6 6 6h1" stroke="rgba(234,242,255,.92)" stroke-width="1.6" stroke-linecap="round"/>
<path d="M12 6c-2.5 0-4 1.8-4 4v3c0 2.2 1.8 4 4 4" stroke="rgba(234,242,255,.92)" stroke-width="1.6" stroke-linecap="round"/>
<path d="M12 9c-1.4 0-2 1.1-2 2.5V13c0 1.8 1.2 3 3 3" stroke="rgba(234,242,255,.92)" stroke-width="1.6" stroke-linecap="round"/>
<path d="M15 10.5V13c0 3 2 5 5 5" stroke="rgba(102,255,204,.9)" stroke-width="1.6" stroke-linecap="round"/>
</svg>
</div>
</div>

<div class="holdText" id="holdText">‡∏Å‡∏î‡∏Ñ‡πâ‡∏≤‡∏á‡∏ó‡∏µ‡πà‡∏•‡∏≤‡∏¢‡∏ô‡∏¥‡πâ‡∏ß‡∏°‡∏∑‡∏≠</div>
</div>
</div>

<div class="row" style="margin-top:12px; justify-content:space-between;">
<button id="btnFxIntro">üéÜ ‡πÄ‡∏≠‡∏ü‡πÄ‡∏ü‡∏Å‡∏ï‡πå</button>
<span class="badge">Tip: iPad ‡∏ï‡πâ‡∏≠‡∏á ‚Äú‡πÅ‡∏ï‡∏∞‚Äù ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏´‡πâ‡πÄ‡∏™‡∏µ‡∏¢‡∏á/‡πÄ‡∏û‡∏•‡∏á‡∏ó‡∏≥‡∏á‡∏≤‡∏ô</span>
</div>
</div>

<!-- GAME 1: Timing bar -->
<div class="panel hidden" id="game1Panel" style="margin-top:12px">
<p class="big">‡πÄ‡∏Å‡∏°‡∏ó‡∏µ‡πà 1: Timing Bar</p>
<p class="sub">‡∏Å‡∏î ‚Äú‡∏´‡∏¢‡∏∏‡∏î‚Äù ‡πÉ‡∏´‡πâ‡πÅ‡∏ó‡πà‡∏á‡∏≠‡∏¢‡∏π‡πà‡πÉ‡∏ô ‚Äú‡πÇ‡∏ã‡∏ô‡∏™‡∏µ‡∏ó‡∏≠‡∏á‚Äù ‡πÉ‡∏´‡πâ‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à 2 ‡∏Ñ‡∏£‡∏±‡πâ‡∏á</p>

<div class="timingBox">
<div class="timingTrack" id="timingTrack">
<div class="timingZone"></div>
<div class="timingPointer" id="timingPointer"></div>
</div>
<div class="row" style="margin-top:12px; justify-content:space-between;">
<span class="badge">‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à: <span id="timingWin">0</span>/2</span>
<span class="badge">‡∏û‡∏¢‡∏≤‡∏¢‡∏≤‡∏°: <span id="timingTry">0</span>/3</span>
</div>
</div>

<div class="row" style="margin-top:12px">
<button id="btnTimingStart">‡πÄ‡∏£‡∏¥‡πà‡∏°</button>
<button id="btnTimingStop" disabled>‡∏´‡∏¢‡∏∏‡∏î</button>
<button id="btnTimingReset">‡∏£‡∏µ‡πÄ‡∏ã‡πá‡∏ï</button>
</div>
<div class="err" id="timingErr"></div>
</div>

<!-- GAME 2: Maze -->
<div class="panel hidden" id="game2Panel" style="margin-top:12px">
<p class="big">‡πÄ‡∏Å‡∏°‡∏ó‡∏µ‡πà 2: ‡πÑ‡∏õ‡πÉ‡∏´‡πâ‡∏ñ‡∏∂‡∏á‡∏´‡∏±‡∏ß‡πÉ‡∏à</p>
<p class="sub">‡πÅ‡∏ï‡∏∞‡∏à‡∏∏‡∏î‡πÄ‡∏£‡∏¥‡πà‡∏° (‡∏ß‡∏á‡∏Å‡∏•‡∏°‡∏ã‡πâ‡∏≤‡∏¢) ‡πÅ‡∏•‡πâ‡∏ß‡∏•‡∏≤‡∏Å‡∏ô‡∏¥‡πâ‡∏ß‡πÑ‡∏õ‡∏ï‡∏≤‡∏°‡∏ó‡∏≤‡∏á‡πÉ‡∏´‡πâ‡∏ñ‡∏∂‡∏á‡∏´‡∏±‡∏ß‡πÉ‡∏à ‚ù§Ô∏è</p>

<div class="mazeWrap">
<canvas id="maze" width="820" height="360"></canvas>
<div class="mazeHint" id="mazeHint">‡∏´‡πâ‡∏≤‡∏°‡∏´‡∏•‡∏∏‡∏î‡∏≠‡∏≠‡∏Å‡∏ô‡∏≠‡∏Å‡∏ó‡∏≤‡∏á ‡∏ñ‡πâ‡∏≤‡∏´‡∏•‡∏∏‡∏î‡∏à‡∏∞‡πÄ‡∏£‡∏¥‡πà‡∏°‡πÉ‡∏´‡∏°‡πà‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥</div>
</div>

<div class="row" style="margin-top:12px">
<button id="btnMazeReset">‡πÄ‡∏£‡∏¥‡πà‡∏°‡πÉ‡∏´‡∏°‡πà</button>
</div>
<div class="err" id="mazeErr"></div>
</div>

<!-- ======= ORIGINAL FLOW (‡πÄ‡∏î‡∏¥‡∏°) ======= -->
<div class="panel hidden" id="gatePanel" style="margin-top:12px">
<p class="big">‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏†‡∏≤‡∏£‡∏Å‡∏¥‡∏à‡∏´‡∏•‡∏±‡∏Å</p>
<p class="sub">
‡∏Ñ‡∏≥‡∏ñ‡∏≤‡∏°‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô: <span class="prompt">‡∏ß‡∏±‡∏ô/‡πÄ‡∏î‡∏∑‡∏≠‡∏ô/‡∏õ‡∏µ‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡∏≠‡∏á Cartoon ‡∏Ñ‡∏∑‡∏≠‡∏≠‡∏∞‡πÑ‡∏£?</span><br>
(‡∏û‡∏¥‡∏°‡∏û‡πå‡∏£‡∏π‡∏õ‡πÅ‡∏ö‡∏ö <span class="prompt">DD/MM/YYYY</span>)
</p>

<div class="row" style="margin-top:10px">
<input id="startPw" placeholder="‡∏û‡∏¥‡∏°‡∏û‡πå‡∏ß‡∏±‡∏ô‡πÄ‡∏Å‡∏¥‡∏î (DD/MM/YYYY)..." autocomplete="off" />
<button id="btnStart">‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏†‡∏≤‡∏£‡∏Å‡∏¥‡∏à</button>
</div>
<div class="err" id="startErr"></div>

<div class="row" style="margin-top:12px; justify-content:space-between;">
<button id="btnPlay1">‚ñ∂ ‡πÄ‡∏•‡πà‡∏ô/‡∏´‡∏¢‡∏∏‡∏î ‡πÄ‡∏û‡∏•‡∏á‡∏´‡∏ô‡πâ‡∏≤‡πÅ‡∏£‡∏Å</button>
<button id="btnFxGate">üéÜ ‡πÄ‡∏≠‡∏ü‡πÄ‡∏ü‡∏Å‡∏ï‡πå</button>
</div>

<audio id="song1" preload="auto" controls style="width:100%; margin-top:10px;"></audio>
<div class="sub" style="margin-top:8px;">
‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏: iPad/iPhone ‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏î‡∏õ‡∏∏‡πà‡∏°‡πÄ‡∏•‡πà‡∏ô‡πÄ‡∏û‡∏•‡∏á‡πÄ‡∏≠‡∏á 1 ‡∏Ñ‡∏£‡∏±‡πâ‡∏á (‡∏Ç‡πâ‡∏≠‡∏à‡∏≥‡∏Å‡∏±‡∏î iOS)
</div>
</div>

<div class="panel hidden" id="missionPanel" style="margin-top:12px">
<p class="big" id="missionTitle">‡∏†‡∏≤‡∏£‡∏Å‡∏¥‡∏à</p>
<p class="sub" id="missionDesc"></p>

<div class="row">
<input id="missionInput" placeholder="‡∏û‡∏¥‡∏°‡∏û‡πå‡∏Ñ‡∏≥‡∏ï‡∏≠‡∏ö/‡∏£‡∏´‡∏±‡∏™..." autocomplete="off" />
<button id="btnSubmit">‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô</button>
</div>
<div class="err" id="missionErr"></div>

<div class="row" style="margin-top:12px; justify-content:flex-end;">
<button id="btnFxMission">üéâ ‡πÇ‡∏õ‡∏£‡∏¢ / üéÜ ‡∏û‡∏•‡∏∏</button>
</div>
</div>

<div class="panel hidden" id="letterPanel" style="margin-top:12px">
<p class="big">üì© ‡∏à‡∏î‡∏´‡∏°‡∏≤‡∏¢‡∏ñ‡∏∂‡∏á Cartoon</p>
<div class="letter" id="letterText"></div>
<div class="row" style="margin-top:12px; justify-content:flex-end;">
<button id="btnNextAfterLetter" disabled>‡∏ñ‡∏±‡∏î‡πÑ‡∏õ</button>
</div>
</div>

<div class="panel hidden" id="colorPanel" style="margin-top:12px">
<p class="big">‡∏Ñ‡∏≥‡∏ñ‡∏≤‡∏°‡∏™‡∏∏‡∏î‡∏ó‡πâ‡∏≤‡∏¢</p>
<p class="sub">‡πÉ‡∏ô‡∏à‡∏î‡∏´‡∏°‡∏≤‡∏¢‡∏°‡∏µ‡∏ä‡πà‡∏≠‡∏á‡∏ß‡πà‡∏≤‡∏á ‚Äú‡∏™‡∏µ‚Ä¶‚Äù ‡πÉ‡∏´‡πâ‡πÄ‡∏ï‡∏¥‡∏°‡∏Ñ‡∏≥‡∏ï‡∏≠‡∏ö</p>
<div class="row">
<input id="colorInput" placeholder="‡∏û‡∏¥‡∏°‡∏û‡πå‡∏Ñ‡∏≥‡∏ï‡∏≠‡∏ö..." autocomplete="off" />
<button id="btnColor">‡∏ñ‡∏±‡∏î‡πÑ‡∏õ</button>
</div>
<div class="err" id="colorErr"></div>
</div>

<div class="panel hidden" id="finalPanel" style="margin-top:12px">
<p class="big">üéâ Happy Birthday Cartoon</p>
<p class="sub">‡∏õ‡∏•‡∏î‡∏•‡πá‡∏≠‡∏Å‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î ‚úÖ</p>

<div class="row" style="justify-content:space-between;">
<button id="btnPlay2">‚ñ∂ ‡πÄ‡∏•‡πà‡∏ô/‡∏´‡∏¢‡∏∏‡∏î ‡πÄ‡∏û‡∏•‡∏á‡∏™‡∏∏‡∏î‡∏ó‡πâ‡∏≤‡∏¢</button>
</div>

<audio id="song2" preload="auto" controls style="width:100%; margin-top:10px;"></audio>
</div>
</div>

<!-- RIGHT -->
<div class="card">
<h1>üñºÔ∏è ‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û‡∏ó‡∏µ‡πà‡∏õ‡∏•‡∏î‡∏•‡πá‡∏≠‡∏Å</h1>
<p class="sub">‡∏£‡∏π‡∏õ‡∏à‡∏∞‡∏Ç‡∏∂‡πâ‡∏ô‡∏ó‡∏µ‡∏•‡∏∞‡∏£‡∏π‡∏õ‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏ó‡∏≥‡∏†‡∏≤‡∏£‡∏Å‡∏¥‡∏à‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á</p>

<div class="gallery">
<div class="photo" id="imgBox1">
<div class="sub">‡∏£‡∏π‡∏õ‡∏ó‡∏µ‡πà 1 (‡∏´‡∏•‡∏±‡∏á‡∏†‡∏≤‡∏£‡∏Å‡∏¥‡∏à 1)</div>
</div>
<div class="photo" id="imgBox2">
<div class="sub">‡∏£‡∏π‡∏õ‡∏ó‡∏µ‡πà 2 (‡∏´‡∏•‡∏±‡∏á‡∏†‡∏≤‡∏£‡∏Å‡∏¥‡∏à 2)</div>
</div>
<div class="photo" id="imgBox3">
<div class="sub">‡∏£‡∏π‡∏õ‡∏ó‡∏µ‡πà 3 (‡∏´‡∏•‡∏±‡∏á‡∏†‡∏≤‡∏£‡∏Å‡∏¥‡∏à 3)</div>
</div>
</div>

<div class="panel" style="margin-top:12px">
<div class="sub">
‡πÑ‡∏ü‡∏•‡πå‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏°‡∏µ‡πÉ‡∏ô repo (root):<br>
<span class="prompt">p1.jpg, p2.jpg, p3.jpg, pause.mp3, happy-birthday.mp3 (‡∏´‡∏£‡∏∑‡∏≠ .m4a)</span>
</div>
</div>
</div>
</div>

<script>
/* =========================
CONFIG (‡πÅ‡∏Å‡πâ‡∏ï‡∏£‡∏á‡∏ô‡∏µ‡πâ‡∏à‡∏∏‡∏î‡πÄ‡∏î‡∏µ‡∏¢‡∏ß)
========================= */
const CONFIG = {
cartoonBirthday: "00/00/0000", // ‚úÖ ‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡πÄ‡∏õ‡πá‡∏ô‡∏ß‡∏±‡∏ô‡πÄ‡∏Å‡∏¥‡∏î‡∏à‡∏£‡∏¥‡∏á‡∏Ç‡∏≠‡∏á Cartoon (DD/MM/YYYY)
song1: "pause.mp3",
song2: "happy-birthday.mp3", // ‡∏ñ‡πâ‡∏≤‡πÄ‡∏õ‡πá‡∏ô .m4a ‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡πÄ‡∏õ‡πá‡∏ô "happy-birthday.m4a"
img1: "p1.jpg",
img2: "p2.jpg",
img3: "p3.jpg",
};

const LETTER = `Happy Birthday ‡∏Ñ‡∏£‡∏±‡∏ö‡∏≠‡πâ‡∏ß‡∏ô ‡∏Ç‡∏≠‡πÉ‡∏´‡πâ‡∏ï‡∏±‡πâ‡∏á‡πÅ‡∏ï‡πà‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ‡πÅ‡∏•‡∏∞‡∏ï‡∏•‡∏≠‡∏î‡πÑ‡∏õ‡πÄ‡∏õ‡πá‡∏ô‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏î‡∏µ‡∏Ç‡∏≠‡∏á‡πÄ‡∏ò‡∏≠ ‡∏Ç‡∏≠‡πÉ‡∏´‡πâ‡∏°‡∏µ‡∏Ñ‡∏ß‡∏≤‡∏°‡∏™‡∏∏‡∏Ç‡∏°‡∏≤‡∏Å‡πÜ‡πÉ‡∏ô‡∏ó‡∏∏‡∏Å‡πÜ‡∏ß‡∏±‡∏ô ‡∏ó‡∏ô‡∏ü‡∏±‡∏á‡πÄ‡∏£‡∏≤‡∏û‡∏π‡∏î‡πÑ‡∏õ‡∏ô‡∏≤‡∏ô‡πÜ ‡∏ö‡∏≤‡∏á‡∏ó‡∏µ‡πÄ‡∏£‡∏≤‡∏≠‡∏≤‡∏à‡∏à‡∏∞‡∏ó‡∏∞‡πÄ‡∏•‡∏≤‡∏∞‡∏Å‡∏±‡∏ô‡πÑ‡∏°‡πà‡∏û‡∏≠‡πÉ‡∏à‡∏Å‡∏±‡∏ô‡∏ö‡πâ‡∏≤‡∏á ‡πÅ‡∏ï‡πà‡πÑ‡∏°‡πà‡πÄ‡∏õ‡πá‡∏ô‡πÑ‡∏£‡πÄ‡∏û‡∏£‡∏≤‡∏∞‡πÄ‡∏Ñ‡πâ‡∏≤‡∏ñ‡∏π‡∏Å‡πÄ‡∏™‡∏°‡∏≠ ‡∏´‡∏¢‡∏≠‡∏Å‡∏à‡∏±‡πâ‡∏ü ‡∏ô‡∏±‡πà‡∏ô‡πÅ‡∏´‡∏•‡∏∞‡∏°‡∏µ‡∏Ñ‡∏ß‡∏≤‡∏°‡∏™‡∏∏‡∏Ç‡∏°‡∏≤‡∏Å‡πÜ‡πÄ‡∏î‡πâ‡∏≠‡∏≠‡πâ‡∏ß‡∏ô ‡∏à‡∏≤‡∏Å PEACE ‡∏™‡∏∏‡∏î‡∏´‡∏•‡πà‡∏≠ ‡∏ñ‡∏∂‡∏á ‡πÄ‡∏ò‡∏≠‡∏ó‡∏µ‡πà‡πÄ‡∏õ‡πá‡∏ô‡∏î‡∏≠‡∏Å‡πÑ‡∏°‡πâ‡∏ó‡∏µ‡πà‡∏™‡∏ß‡∏¢‡∏™‡∏î‡∏á‡∏î‡∏á‡∏≤‡∏° ‡∏™‡∏µ‚Ä¶`;

/* =========================
State
steps: 0 intro, 1 game1, 2 game2, 3 gate, 4..9 missions/final
========================= */
let step = 0;

const $ = (id)=>document.getElementById(id);
const toast = (msg)=>{
const t=$("toast");
t.textContent=msg;
t.classList.add("show");
setTimeout(()=>t.classList.remove("show"), 1600);
};
const norm = (s)=> (s ?? "").trim();
const normLower = (s)=> norm(s).toLowerCase();

/* progress */
function setProgress(){
const total = 9;
const pct = Math.min(100, Math.round((step/total)*100));
$("stepLabel").textContent = step;
$("fill").style.width = pct + "%";
}
setProgress();

/* =========================
Christmas lights
========================= */
(function buildLights(){
const el = $("lights");
if(!el) return;
el.innerHTML = "";
const colors = ["#ff4d4d","#66ffcc","#86a8ff","#ffd966","#ff8ad6"];
const count = Math.min(34, Math.max(18, Math.floor(window.innerWidth/24)));
for(let i=0;i<count;i++){
const b = document.createElement("i");
const c = colors[i % colors.length];
b.style.background = c;
b.style.boxShadow = `0 0 16px ${c}55`;
el.appendChild(b);
}
})();

/* =========================
SFX (WebAudio)
========================= */
let audioCtx = null;
function ensureAudio(){
if(!audioCtx){
audioCtx = new (window.AudioContext || window.webkitAudioContext)();
}
if(audioCtx.state === "suspended") audioCtx.resume();
}
function beep({freq=880, dur=0.10, type="sine", vol=0.05} = {}){
try{
ensureAudio();
const o = audioCtx.createOscillator();
const g = audioCtx.createGain();
o.type = type;
o.frequency.value = freq;
g.gain.value = vol;
o.connect(g); g.connect(audioCtx.destination);
o.start();
o.stop(audioCtx.currentTime + dur);
}catch(e){}
}
function sfxSuccess(){ beep({freq:988,dur:0.08,vol:0.06}); setTimeout(()=>beep({freq:1319,dur:0.10,vol:0.06}), 90); }
function sfxFail(){ beep({freq:220,dur:0.12,type:"square",vol:0.03}); }

/* =========================
Effects: Snow / Confetti / Fireworks
========================= */
const c0 = $("snow"), x0 = c0.getContext("2d");
const c1 = $("confetti"), x1 = c1.getContext("2d");
const c2 = $("fire"), x2 = c2.getContext("2d");
let parts=[], sparks=[], fireLooping=false;

function resize(){
c0.width = window.innerWidth; c0.height = window.innerHeight;
c1.width = window.innerWidth; c1.height = window.innerHeight;
c2.width = window.innerWidth; c2.height = window.innerHeight;
}
window.addEventListener("resize", resize);
resize();

/* snow */
let flakes=[];
function initSnow(){
flakes = Array.from({length: 120}, ()=>({
x: Math.random()*c0.width,
y: Math.random()*c0.height,
r: 0.8 + Math.random()*2.2,
vy: 0.6 + Math.random()*1.8,
vx: -0.4 + Math.random()*0.8,
a: 0.35 + Math.random()*0.45
}));
}
initSnow();
window.addEventListener("resize", initSnow);

function tickSnow(){
x0.clearRect(0,0,c0.width,c0.height);
for(const f of flakes){
f.x += f.vx; f.y += f.vy;
if(f.y > c0.height + 10){ f.y = -10; f.x = Math.random()*c0.width; }
if(f.x < -10) f.x = c0.width + 10;
if(f.x > c0.width + 10) f.x = -10;
x0.beginPath();
x0.arc(f.x,f.y,f.r,0,Math.PI*2);
x0.fillStyle = `rgba(255,255,255,${f.a})`;
x0.fill();
}
requestAnimationFrame(tickSnow);
}
requestAnimationFrame(tickSnow);

/* confetti */
function makePart(){
return {
x: Math.random()*c1.width, y: Math.random()*-c1.height,
r: 3+Math.random()*6,
vx: -1+Math.random()*2,
vy: 2+Math.random()*5,
rot: Math.random()*Math.PI,
vr: -0.12+Math.random()*0.24,
hue: Math.random()*360
};
}
function startConfetti(){
parts = Array.from({length: 140}, ()=>makePart());
requestAnimationFrame(tickConfetti);
}
function burstConfetti(n=140){
for(let i=0;i<n;i++){
const p = makePart();
p.y = Math.random()*c1.height*0.25;
p.vy = 4+Math.random()*7;
parts.push(p);
}
parts = parts.slice(-420);
}
function tickConfetti(){
x1.clearRect(0,0,c1.width,c1.height);
for(const p of parts){
p.x += p.vx; p.y += p.vy; p.rot += p.vr;
if(p.y > c1.height+30){ p.y=-30; p.x=Math.random()*c1.width; }
x1.save();
x1.translate(p.x,p.y); x1.rotate(p.rot);
x1.fillStyle = `hsla(${p.hue},90%,65%,.95)`;
x1.fillRect(-p.r,-p.r,p.r*2,p.r*2);
x1.restore();
}
requestAnimationFrame(tickConfetti);
}
startConfetti();

/* fireworks */
function fireworksBurst(count=10){
for(let i=0;i<count;i++){
const cx = Math.random()*c2.width*0.9 + c2.width*0.05;
const cy = Math.random()*c2.height*0.45 + c2.height*0.05;
const hue = Math.random()*360;
for(let k=0;k<32;k++){
const a = (Math.PI*2) * (k/32);
const sp = 2 + Math.random()*4.5;
sparks.push({
x: cx, y: cy,
vx: Math.cos(a)*sp*(0.7+Math.random()*0.7),
vy: Math.sin(a)*sp*(0.7+Math.random()*0.7),
life: 40 + Math.random()*22,
hue
});
}
}
if(!fireLooping){ fireLooping=true; requestAnimationFrame(tickFire); }
}
function tickFire(){
x2.clearRect(0,0,c2.width,c2.height);
for(const s of sparks){
s.x += s.vx; s.y += s.vy;
s.vy += 0.04;
s.life -= 1;
x2.beginPath();
x2.arc(s.x,s.y,1.6,0,Math.PI*2);
x2.fillStyle = `hsla(${s.hue},95%,70%,${Math.max(0,s.life/60)})`;
x2.fill();
}
sparks = sparks.filter(s=>s.life>0);
if(sparks.length>0) requestAnimationFrame(tickFire);
else { fireLooping=false; x2.clearRect(0,0,c2.width,c2.height); }
}

/* =========================
Audio: ‡∏Å‡∏±‡∏ô‡πÄ‡∏û‡∏•‡∏á‡∏ã‡πâ‡∏≠‡∏ô‡∏Å‡∏±‡∏ô
========================= */
const song1 = $("song1");
const song2 = $("song2");
song1.src = CONFIG.song1;
song2.src = CONFIG.song2;

function stopOther(current){
const other = (current === song1) ? song2 : song1;
if(!other.paused) other.pause();
}
song1.addEventListener("play", ()=>stopOther(song1));
song2.addEventListener("play", ()=>stopOther(song2));

async function togglePlay(audioEl, btnEl, labelPlay, labelPause){
stopOther(audioEl);
audioEl.load();
try{
if(audioEl.paused){
await audioEl.play();
btnEl.textContent = labelPause;
toast("‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÄ‡∏•‡πà‡∏ô‡πÄ‡∏û‡∏•‡∏á üéµ");
}else{
audioEl.pause();
btnEl.textContent = labelPlay;
toast("‡∏´‡∏¢‡∏∏‡∏î‡πÄ‡∏û‡∏•‡∏á‡πÅ‡∏•‡πâ‡∏ß");
}
}catch(e){
alert("‡πÄ‡∏•‡πà‡∏ô‡πÄ‡∏û‡∏•‡∏á‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ\n\n‡πÄ‡∏ä‡πá‡∏Å‡∏ß‡πà‡∏≤‡πÑ‡∏ü‡∏•‡πå‡πÄ‡∏™‡∏µ‡∏¢‡∏á‡∏≠‡∏¢‡∏π‡πà‡πÉ‡∏ô repo ‡πÅ‡∏•‡∏∞‡∏ä‡∏∑‡πà‡∏≠‡πÑ‡∏ü‡∏•‡πå‡∏ï‡∏£‡∏á‡πÄ‡∏õ‡πä‡∏∞\n- pause.mp3\n- happy-birthday.mp3 ‡∏´‡∏£‡∏∑‡∏≠ .m4a\n\n‡∏ö‡∏ô iPad ‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏î‡πÄ‡∏•‡πà‡∏ô‡πÄ‡∏≠‡∏á 1 ‡∏Ñ‡∏£‡∏±‡πâ‡∏á");
}
}

/* =========================
UI helpers
========================= */
function show(id){ $(id).classList.remove("hidden"); }
function hide(id){ $(id).classList.add("hidden"); }

function goStep(newStep){
step = newStep;
setProgress();

// hide all main panels
["introPanel","game1Panel","game2Panel","gatePanel","missionPanel","letterPanel","colorPanel","finalPanel"]
.forEach(hide);

if(step===0) show("introPanel");
if(step===1) show("game1Panel");
if(step===2) show("game2Panel");
if(step===3) show("gatePanel");
if(step>=4 && step<=7) show("missionPanel");
if(step===8) show("letterPanel");
if(step===9) show("colorPanel");
if(step===10) show("finalPanel");
}
goStep(0);

/* ===== Intro fingerprint hold ===== */
let holdTimer=null;
let holdStart=0;
const HOLD_MS = 1600;
function setHoldProgress(pct){
// ‡πÉ‡∏ä‡πâ clip-path ‡πÅ‡∏ö‡∏ö wedge
const ringAfter = $("finger").querySelector(".ring");
const a = Math.max(0, Math.min(1, pct));
// ‡∏™‡∏£‡πâ‡∏≤‡∏á wedge polygon ‡πÅ‡∏ö‡∏ö‡∏á‡πà‡∏≤‡∏¢ (12 steps)
const steps = 36;
const pts = ["50% 50%","50% 0%"];
const angleMax = a * Math.PI*2;
for(let i=0;i<=steps;i++){
const ang = (-Math.PI/2) + (angleMax*(i/steps));
const x = 50 + 50*Math.cos(ang);
const y = 50 + 50*Math.sin(ang);
pts.push(`${x.toFixed(2)}% ${y.toFixed(2)}%`);
}
// apply to ::after via inline style trick: set CSS variable
$("finger").style.setProperty("--wedge", `polygon(${pts.join(",")})`);
// update pseudo style by injecting once
}
(function injectWedgeCSS(){
const s=document.createElement("style");
s.textContent = `.ring::after{ clip-path: var(--wedge, polygon(50% 50%, 50% 0, 50% 0, 50% 50%)); }`;
document.head.appendChild(s);
})();

function holdStartFn(){
ensureAudio(); // ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏´‡πâ iOS ‡∏¢‡∏≠‡∏°‡πÉ‡∏´‡πâ‡πÄ‡∏™‡∏µ‡∏¢‡∏á‡∏ó‡∏≥‡∏á‡∏≤‡∏ô‡∏ï‡∏±‡πâ‡∏á‡πÅ‡∏ï‡πà‡πÅ‡∏ï‡∏∞‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡πÅ‡∏£‡∏Å
const finger = $("finger");
finger.classList.add("holding");
$("holdText").textContent = "‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏™‡πÅ‡∏Å‡∏ô...";
holdStart = performance.now();
setHoldProgress(0);

function tick(){
const now = performance.now();
const dt = now - holdStart;
const pct = dt / HOLD_MS;
setHoldProgress(pct);
if(pct >= 1){
holdEndFn(true);
return;
}
holdTimer = requestAnimationFrame(tick);
}
holdTimer = requestAnimationFrame(tick);
}
function holdEndFn(success){
const finger = $("finger");
finger.classList.remove("holding");
if(holdTimer){ cancelAnimationFrame(holdTimer); holdTimer=null; }
setHoldProgress(0);

if(success){
toast("‡∏õ‡∏•‡∏î‡∏•‡πá‡∏≠‡∏Å‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à ‚úÖ");
sfxSuccess();
burstConfetti(160);
fireworksBurst(10);
$("holdText").textContent = "‡∏õ‡∏•‡∏î‡∏•‡πá‡∏≠‡∏Å‡πÅ‡∏•‡πâ‡∏ß";
setTimeout(()=>goStep(1), 450);
}else{
$("holdText").textContent = "‡∏Å‡∏î‡∏Ñ‡πâ‡∏≤‡∏á‡∏ó‡∏µ‡πà‡∏•‡∏≤‡∏¢‡∏ô‡∏¥‡πâ‡∏ß‡∏°‡∏∑‡∏≠";
}
}
(function setupHold(){
const finger = $("finger");
const down = (e)=>{ e.preventDefault(); if(step!==0) return; holdStartFn(); };
const up = (e)=>{ e.preventDefault(); if(step!==0) return; holdEndFn(false); };
finger.addEventListener("pointerdown", down);
window.addEventListener("pointerup", up);
window.addEventListener("pointercancel", up);
})();

$("btnFxIntro").addEventListener("click", ()=>{ burstConfetti(180); fireworksBurst(14); });

/* =========================
GAME 1: Timing Bar
========================= */
let timingRAF=null;
let timingPos=0.0;
let timingDir=1;
let timingRunning=false;
let timingWin=0;
let timingTry=0;

function timingUpdateUI(){
$("timingWin").textContent = String(timingWin);
$("timingTry").textContent = String(timingTry);
}
timingUpdateUI();

function timingStart(){
$("timingErr").textContent = "";
if(timingRunning) return;
timingRunning = true;
$("btnTimingStart").disabled = true;
$("btnTimingStop").disabled = false;

const speed = 0.9; // cycles per second-ish
let last = performance.now();
function loop(now){
if(!timingRunning) return;
const dt = (now-last)/1000;
last = now;

timingPos += timingDir * dt * speed;
if(timingPos >= 1){ timingPos=1; timingDir=-1; }
if(timingPos <= 0){ timingPos=0; timingDir=1; }

$("timingPointer").style.left = (timingPos*100) + "%";
timingRAF = requestAnimationFrame(loop);
}
timingRAF = requestAnimationFrame(loop);
}

function timingStop(){
if(!timingRunning) return;
timingRunning = false;
if(timingRAF){ cancelAnimationFrame(timingRAF); timingRAF=null; }

$("btnTimingStart").disabled = false;
$("btnTimingStop").disabled = true;

// zone: left 42%, width 16% => [0.42, 0.58]
timingTry++;
const ok = (timingPos >= 0.42 && timingPos <= 0.58);

if(ok){
timingWin++;
sfxSuccess();
toast("‡πÇ‡∏î‡∏ô‡πÇ‡∏ã‡∏ô‡∏ó‡∏≠‡∏á ‚úÖ");
burstConfetti(120);
}else{
sfxFail();
toast("‡∏û‡∏•‡∏≤‡∏î! ‡∏•‡∏≠‡∏á‡πÉ‡∏´‡∏°‡πà");
}
timingUpdateUI();

if(timingWin >= 2){
toast("‡∏ú‡πà‡∏≤‡∏ô‡πÄ‡∏Å‡∏°‡∏ó‡∏µ‡πà 1 ‚úÖ");
fireworksBurst(12);
setTimeout(()=>goStep(2), 550);
return;
}

if(timingTry >= 3 && timingWin < 2){
$("timingErr").textContent = "‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏ú‡πà‡∏≤‡∏ô (‡∏ï‡πâ‡∏≠‡∏á‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à 2 ‡∏Ñ‡∏£‡∏±‡πâ‡∏á) ‚Äî ‡∏Å‡∏î‡∏£‡∏µ‡πÄ‡∏ã‡πá‡∏ï‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏£‡∏¥‡πà‡∏°‡πÉ‡∏´‡∏°‡πà";
}
}

function timingReset(){
timingRunning=false;
if(timingRAF){ cancelAnimationFrame(timingRAF); timingRAF=null; }
timingPos = 0;
timingDir = 1;
timingWin = 0;
timingTry = 0;
$("timingPointer").style.left = "0%";
$("btnTimingStart").disabled = false;
$("btnTimingStop").disabled = true;
$("timingErr").textContent = "";
timingUpdateUI();
}

$("btnTimingStart").addEventListener("click", timingStart);
$("btnTimingStop").addEventListener("click", timingStop);
$("btnTimingReset").addEventListener("click", timingReset);

/* =========================
GAME 2: Maze (trace path)
========================= */
const maze = $("maze");
const mx = maze.getContext("2d");

// Define a polyline path in canvas coords
const PATH = [
{x: 70, y: 180},
{x: 170, y: 180},
{x: 170, y: 90},
{x: 330, y: 90},
{x: 330, y: 260},
{x: 520, y: 260},
{x: 520, y: 120},
{x: 680, y: 120},
{x: 680, y: 200},
{x: 760, y: 200},
];
const PATH_WIDTH = 22;
const START = {x: PATH[0].x, y: PATH[0].y, r: 16};
const END = {x: PATH[PATH.length-1].x, y: PATH[PATH.length-1].y, r: 18};

let tracing=false;

function distToSegment(px,py, ax,ay, bx,by){
const vx = bx-ax, vy = by-ay;
const wx = px-ax, wy = py-ay;
const c1 = vx*wx + vy*wy;
if(c1 <= 0) return Math.hypot(px-ax, py-ay);
const c2 = vx*vx + vy*vy;
if(c2 <= c1) return Math.hypot(px-bx, py-by);
const t = c1 / c2;
const projx = ax + t*vx, projy = ay + t*vy;
return Math.hypot(px-projx, py-projy);
}

function insidePath(px,py){
// within width from any segment
for(let i=0;i<PATH.length-1;i++){
const a=PATH[i], b=PATH[i+1];
const d = distToSegment(px,py,a.x,a.y,b.x,b.y);
if(d <= PATH_WIDTH) return true;
}
return false;
}

function drawMaze(){
mx.clearRect(0,0,maze.width,maze.height);

// glow background lines
mx.lineCap = "round";
mx.lineJoin = "round";

// corridor (thick)
mx.beginPath();
mx.moveTo(PATH[0].x, PATH[0].y);
for(let i=1;i<PATH.length;i++) mx.lineTo(PATH[i].x, PATH[i].y);
mx.strokeStyle = "rgba(255,255,255,.10)";
mx.lineWidth = PATH_WIDTH*2 + 12;
mx.stroke();

// actual path
mx.beginPath();
mx.moveTo(PATH[0].x, PATH[0].y);
for(let i=1;i<PATH.length;i++) mx.lineTo(PATH[i].x, PATH[i].y);
mx.strokeStyle = "rgba(102,255,204,.75)";
mx.lineWidth = PATH_WIDTH*2;
mx.stroke();

// start circle
mx.beginPath();
mx.arc(START.x, START.y, START.r, 0, Math.PI*2);
mx.fillStyle = "rgba(134,168,255,.35)";
mx.fill();
mx.strokeStyle = "rgba(234,242,255,.35)";
mx.lineWidth = 2;
mx.stroke();
mx.fillStyle = "rgba(234,242,255,.9)";
mx.font = "12px ui-monospace";
mx.fillText("START", START.x-18, START.y+4);

// end (heart)
mx.save();
mx.translate(END.x, END.y);
mx.fillStyle = "rgba(255,77,77,.9)";
mx.beginPath();
mx.moveTo(0, 6);
mx.bezierCurveTo(0,-10, 22,-10, 22, 6);
mx.bezierCurveTo(22, 22, 0, 32, 0, 44);
mx.bezierCurveTo(0, 32, -22, 22, -22, 6);
mx.bezierCurveTo(-22,-10, 0,-10, 0, 6);
mx.closePath();
mx.scale(0.45,0.45);
mx.fill();
mx.restore();
mx.fillStyle = "rgba(255,217,102,.9)";
mx.font = "12px ui-monospace";
mx.fillText("‚ù§Ô∏è", END.x-6, END.y+5);
}

function mazeReset(msg){
tracing=false;
$("mazeErr").textContent = msg || "";
drawMaze();
}

function canvasPointFromEvent(e){
const rect = maze.getBoundingClientRect();
const cx = (e.clientX - rect.left) * (maze.width / rect.width);
const cy = (e.clientY - rect.top) * (maze.height / rect.height);
return {x:cx,y:cy};
}

function nearStart(p){
return Math.hypot(p.x-START.x, p.y-START.y) <= START.r + 10;
}
function reachedEnd(p){
return Math.hypot(p.x-END.x, p.y-END.y) <= END.r + 18;
}

maze.addEventListener("pointerdown", (e)=>{
if(step !== 2) return;
e.preventDefault();
const p = canvasPointFromEvent(e);
if(nearStart(p)){
tracing = true;
$("mazeErr").textContent = "";
sfxSuccess();
}else{
tracing = false;
sfxFail();
$("mazeErr").textContent = "‡∏ï‡πâ‡∏≠‡∏á‡πÅ‡∏ï‡∏∞‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ó‡∏µ‡πà‡∏ß‡∏á‡∏Å‡∏•‡∏° START ‡∏Å‡πà‡∏≠‡∏ô";
}
});

maze.addEventListener("pointermove", (e)=>{
if(step !== 2) return;
if(!tracing) return;
e.preventDefault();

const p = canvasPointFromEvent(e);

// if outside corridor => reset
if(!insidePath(p.x,p.y)){
sfxFail();
mazeReset("‡∏´‡∏•‡∏∏‡∏î‡∏≠‡∏≠‡∏Å‡∏ô‡∏≠‡∏Å‡∏ó‡∏≤‡∏á ‚Äî ‡πÄ‡∏£‡∏¥‡πà‡∏°‡πÉ‡∏´‡∏°‡πà");
return;
}

// reached end
if(reachedEnd(p)){
tracing=false;
sfxSuccess();
toast("‡∏ú‡πà‡∏≤‡∏ô‡πÄ‡∏Å‡∏°‡∏ó‡∏µ‡πà 2 ‚úÖ");
burstConfetti(200);
fireworksBurst(14);
setTimeout(()=>goStep(3), 550);
}
});

window.addEventListener("pointerup", ()=>{
if(step===2) tracing=false;
});

$("btnMazeReset").addEventListener("click", ()=>mazeReset(""));

/* draw when entering game2 */
const origGoStep = goStep;
goStep = function(newStep){
origGoStep(newStep);
if(newStep===2) mazeReset("");
};
goStep(0);

/* =========================
ORIGINAL FLOW (‡πÄ‡∏î‡∏¥‡∏°)
========================= */
function setMission(title, desc, placeholder){
$("missionTitle").textContent = title;
$("missionDesc").textContent = desc;
$("missionInput").value = "";
$("missionInput").placeholder = placeholder || "‡∏û‡∏¥‡∏°‡∏û‡πå‡∏Ñ‡∏≥‡∏ï‡∏≠‡∏ö/‡∏£‡∏´‡∏±‡∏™...";
$("missionErr").textContent = "";
}

function revealImage(which){
const mk = (src, capText)=>{
const img = document.createElement("img");
img.src = src;
const cap = document.createElement("div");
cap.className = "cap";
cap.textContent = capText;
return {img, cap};
};
if(which===1){
const box=$("imgBox1"); box.innerHTML="";
const {img,cap}=mk(CONFIG.img1,"‚úÖ ‡∏£‡∏π‡∏õ‡∏ó‡∏µ‡πà 1 ‡∏õ‡∏•‡∏î‡∏•‡πá‡∏≠‡∏Å‡πÅ‡∏•‡πâ‡∏ß");
box.appendChild(img); box.appendChild(cap);
}
if(which===2){
const box=$("imgBox2"); box.innerHTML="";
const {img,cap}=mk(CONFIG.img2,"‚úÖ ‡∏£‡∏π‡∏õ‡∏ó‡∏µ‡πà 2 ‡∏õ‡∏•‡∏î‡∏•‡πá‡∏≠‡∏Å‡πÅ‡∏•‡πâ‡∏ß");
box.appendChild(img); box.appendChild(cap);
}
if(which===3){
const box=$("imgBox3"); box.innerHTML="";
const {img,cap}=mk(CONFIG.img3,"‚úÖ ‡∏£‡∏π‡∏õ‡∏ó‡∏µ‡πà 3 ‡∏õ‡∏•‡∏î‡∏•‡πá‡∏≠‡∏Å‡πÅ‡∏•‡πâ‡∏ß");
box.appendChild(img); box.appendChild(cap);
}
}

/* typewriter */
let typingTimer=null;
function typeLetter(text){
const box=$("letterText");
const btn=$("btnNextAfterLetter");
if(typingTimer) clearInterval(typingTimer);

btn.disabled = true;
box.innerHTML = "";

const cursor=document.createElement("span");
cursor.className="cursor";
cursor.textContent="‚ñç";
box.appendChild(cursor);

let i=0;
typingTimer = setInterval(()=>{
if(i >= text.length){
clearInterval(typingTimer);
typingTimer=null;
cursor.remove();
btn.disabled = false;
return;
}
cursor.insertAdjacentText("beforebegin", text[i]);
i++;
}, 22);
}

/* effects buttons */
$("btnFxGate").addEventListener("click", ()=>{ burstConfetti(180); fireworksBurst(14); });
$("btnFxMission").addEventListener("click", ()=>{ burstConfetti(200); fireworksBurst(12); });

/* audio buttons */
$("btnPlay1").addEventListener("click", ()=> togglePlay(song1, $("btnPlay1"), "‚ñ∂ ‡πÄ‡∏•‡πà‡∏ô/‡∏´‡∏¢‡∏∏‡∏î ‡πÄ‡∏û‡∏•‡∏á‡∏´‡∏ô‡πâ‡∏≤‡πÅ‡∏£‡∏Å", "‚è∏ ‡∏´‡∏¢‡∏∏‡∏î‡πÄ‡∏û‡∏•‡∏á‡∏´‡∏ô‡πâ‡∏≤‡πÅ‡∏£‡∏Å"));
$("btnPlay2").addEventListener("click", ()=> togglePlay(song2, $("btnPlay2"), "‚ñ∂ ‡πÄ‡∏•‡πà‡∏ô/‡∏´‡∏¢‡∏∏‡∏î ‡πÄ‡∏û‡∏•‡∏á‡∏™‡∏∏‡∏î‡∏ó‡πâ‡∏≤‡∏¢", "‚è∏ ‡∏´‡∏¢‡∏∏‡∏î‡πÄ‡∏û‡∏•‡∏á‡∏™‡∏∏‡∏î‡∏ó‡πâ‡∏≤‡∏¢"));

/* gate start */
$("btnStart").addEventListener("click", ()=>{
const v = norm($("startPw").value);
$("startErr").textContent = "";

if(v !== CONFIG.cartoonBirthday){
$("startErr").textContent = "‡∏Ñ‡∏≥‡∏ï‡∏≠‡∏ö‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á";
sfxFail();
return;
}

toast("‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏†‡∏≤‡∏£‡∏Å‡∏¥‡∏à‡πÅ‡∏•‡πâ‡∏ß ‚úÖ");
sfxSuccess();
burstConfetti(160);
fireworksBurst(10);

// jump to mission step 4
step = 4; setProgress();
hide("gatePanel"); show("missionPanel");
setMission(
"‡∏†‡∏≤‡∏£‡∏Å‡∏¥‡∏à‡∏ó‡∏µ‡πà 1",
"‡∏Ñ‡∏≥‡∏ñ‡∏≤‡∏°: ‡∏ß‡∏±‡∏ô‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡∏≠‡∏á PEACE ‡∏Ñ‡∏∑‡∏≠‡∏ß‡∏±‡∏ô‡πÑ‡∏´‡∏ô?",
"‡∏û‡∏¥‡∏°‡∏û‡πå‡πÄ‡∏õ‡πá‡∏ô‡∏£‡∏π‡∏õ‡πÅ‡∏ö‡∏ö DD/MM/YYYY"
);
});

$("startPw").addEventListener("keydown", (e)=>{ if(e.key==="Enter") $("btnStart").click(); });

/* mission submit */
$("btnSubmit").addEventListener("click", ()=>{
const ansRaw = norm($("missionInput").value);
const ansLower = normLower(ansRaw);
$("missionErr").textContent = "";

if(step===4){
if(ansRaw !== "04/05/2007"){
$("missionErr").textContent = "‡∏Ñ‡∏≥‡∏ï‡∏≠‡∏ö‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á";
sfxFail();
return;
}
revealImage(1);
toast("‡∏õ‡∏•‡∏î‡∏•‡πá‡∏≠‡∏Å‡∏£‡∏π‡∏õ‡∏ó‡∏µ‡πà 1 ‚úÖ");
sfxSuccess();
burstConfetti(160);
step = 5; setProgress();
setMission(
"‡∏†‡∏≤‡∏£‡∏Å‡∏¥‡∏à‡∏ó‡∏µ‡πà 2",
"‡πÉ‡∏´‡πâ‡∏™‡πà‡∏á‡∏£‡∏π‡∏õ Cartoon ‡∏ä‡∏π 2 ‡∏ô‡∏¥‡πâ‡∏ß‡∏°‡∏≤‡πÉ‡∏ô LINE ‡πÉ‡∏´‡πâ PEACE ‡πÅ‡∏•‡πâ‡∏ß‡∏£‡∏≠‡∏£‡∏±‡∏ö‡∏£‡∏´‡∏±‡∏™‡∏à‡∏≤‡∏Å‡πÉ‡∏ô LINE (‡∏û‡∏¥‡∏°‡∏û‡πå‡∏£‡∏´‡∏±‡∏™‡∏ó‡∏µ‡πà‡πÑ‡∏î‡πâ)",
"‡∏û‡∏¥‡∏°‡∏û‡πå‡∏£‡∏´‡∏±‡∏™‡∏ó‡∏µ‡πà‡πÑ‡∏î‡πâ‡∏£‡∏±‡∏ö..."
);
return;
}

if(step===5){
if(ansRaw !== "Narak Mak" && ansLower !== "narak mak"){
$("missionErr").textContent = "‡∏£‡∏´‡∏±‡∏™‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á";
sfxFail();
return;
}
revealImage(2);
toast("‡∏õ‡∏•‡∏î‡∏•‡πá‡∏≠‡∏Å‡∏£‡∏π‡∏õ‡∏ó‡∏µ‡πà 2 ‚úÖ");
sfxSuccess();
fireworksBurst(12);
step = 6; setProgress();
setMission(
"‡∏†‡∏≤‡∏£‡∏Å‡∏¥‡∏à‡∏ó‡∏µ‡πà 3",
"‡πÉ‡∏´‡πâ‡πÇ‡∏≠‡∏ô‡πÄ‡∏á‡∏¥‡∏ô‡πÉ‡∏´‡πâ PEACE 10 ‡∏ö‡∏≤‡∏ó ‡πÅ‡∏•‡πâ‡∏ß‡∏£‡∏≠‡∏£‡∏±‡∏ö‡∏£‡∏´‡∏±‡∏™‡πÉ‡∏ô IG (‡∏û‡∏¥‡∏°‡∏û‡πå‡∏£‡∏´‡∏±‡∏™‡∏ó‡∏µ‡πà‡πÑ‡∏î‡πâ)",
"‡∏û‡∏¥‡∏°‡∏û‡πå‡∏£‡∏´‡∏±‡∏™‡∏ó‡∏µ‡πà‡πÑ‡∏î‡πâ‡∏£‡∏±‡∏ö..."
);
return;
}

if(step===6){
if(ansRaw !== "Thank you" && ansLower !== "thank you"){
$("missionErr").textContent = "‡∏£‡∏´‡∏±‡∏™‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á";
sfxFail();
return;
}
revealImage(3);
toast("‡∏õ‡∏•‡∏î‡∏•‡πá‡∏≠‡∏Å‡∏£‡∏π‡∏õ‡∏ó‡∏µ‡πà 3 ‚úÖ");
sfxSuccess();
burstConfetti(220);
fireworksBurst(18);
step = 7; setProgress();
setMission(
"‡∏†‡∏≤‡∏£‡∏Å‡∏¥‡∏à‡πÄ‡∏™‡∏£‡πá‡∏à‡∏™‡∏¥‡πâ‡∏ô ‚úÖ",
"‡∏û‡∏£‡πâ‡∏≠‡∏°‡∏≠‡πà‡∏≤‡∏ô‡∏à‡∏î‡∏´‡∏°‡∏≤‡∏¢‡πÑ‡∏´‡∏°? ‡∏ñ‡πâ‡∏≤‡∏û‡∏£‡πâ‡∏≠‡∏° ‡∏û‡∏¥‡∏°‡∏û‡πå‡∏Ñ‡∏≥‡∏ß‡πà‡∏≤ ‚Äú‡∏û‡∏£‡πâ‡∏≠‡∏°‚Äù",
"‡∏û‡∏¥‡∏°‡∏û‡πå: ‡∏û‡∏£‡πâ‡∏≠‡∏°"
);
return;
}

if(step===7){
if(ansRaw !== "‡∏û‡∏£‡πâ‡∏≠‡∏°"){
$("missionErr").textContent = "‡∏Ñ‡∏≥‡∏ï‡∏≠‡∏ö‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á";
sfxFail();
return;
}
toast("‡πÄ‡∏õ‡∏¥‡∏î‡∏à‡∏î‡∏´‡∏°‡∏≤‡∏¢‡πÅ‡∏•‡πâ‡∏ß üì©");
sfxSuccess();
hide("missionPanel");
step = 8; setProgress();
show("letterPanel");
typeLetter(LETTER);
return;
}
});

$("missionInput").addEventListener("keydown", (e)=>{ if(e.key==="Enter") $("btnSubmit").click(); });

/* letter next */
$("btnNextAfterLetter").addEventListener("click", ()=>{
hide("letterPanel");
step = 9; setProgress();
show("colorPanel");
});

/* color */
$("btnColor").addEventListener("click", ()=>{
const v = norm($("colorInput").value);
$("colorErr").textContent = "";
if(v !== "‡∏ó‡∏≠‡∏á"){
$("colorErr").textContent = "‡∏Ñ‡∏≥‡∏ï‡∏≠‡∏ö‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á";
sfxFail();
return;
}
toast("‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á ‚úÖ ‡πÑ‡∏õ‡∏´‡∏ô‡πâ‡∏≤‡∏™‡∏∏‡∏î‡∏ó‡πâ‡∏≤‡∏¢");
sfxSuccess();
fireworksBurst(18);
burstConfetti(240);
hide("colorPanel");
step = 10; setProgress();
show("finalPanel");
});
$("colorInput").addEventListener("keydown", (e)=>{ if(e.key==="Enter") $("btnColor").click(); });

/* Ensure when leaving game2 to gate */
(function gateAfterGames(){
const original = goStep;
// already overridden earlier; just ensure proper state when step=3
// (panel switching handled in goStep)
})();
</script>
</body>
</html>
